name: DOW Integration Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'DMAIC_V3/**'
      - 'orchestrator_config.yaml'
      - 'ranking.yaml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

env:
  PYTHON_VERSION: '3.10'

jobs:
  test:
    name: Test DOW Agents
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt || echo "No requirements.txt found"
    
    - name: Verify DOW agents exist
      run: |
        ls -la DMAIC_V3/local_mcp/agents/dow_*.py
        echo "Found $(ls DMAIC_V3/local_mcp/agents/dow_*.py | wc -l) DOW agents"
    
    - name: Test agent help commands
      run: |
        python DMAIC_V3/local_mcp/agents/dow_metadata_injector.py --help
        python DMAIC_V3/local_mcp/agents/dow_recursive_hooks_injector.py --help
        python DMAIC_V3/local_mcp/agents/dow_convergence_calculator.py --help
        python DMAIC_V3/local_mcp/agents/dow_knowledge_extractor.py --help
    
    - name: Test executor help
      run: |
        python DMAIC_V3/dow_integration_executor.py --help

  integration:
    name: Run DOW Integration
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt || echo "No requirements.txt found"
    
    - name: Create test data directory
      run: |
        mkdir -p DMAIC_CANONICAL_OUTPUT
        echo "Created DMAIC_CANONICAL_OUTPUT directory"
    
    - name: Create sample JSON files
      run: |
        cat > DMAIC_CANONICAL_OUTPUT/phase1_define.json << 'EOF'
        {
          "phase": "define",
          "iteration": 0,
          "timestamp": "2025-01-15T00:00:00Z",
          "data": {
            "objectives": ["Test objective 1", "Test objective 2"],
            "scope": "Test scope"
          }
        }
        EOF
        
        cat > DMAIC_CANONICAL_OUTPUT/phase2_measure.json << 'EOF'
        {
          "phase": "measure",
          "iteration": 0,
          "timestamp": "2025-01-15T00:00:00Z",
          "data": {
            "metrics": ["metric1", "metric2"],
            "baseline": 100
          }
        }
        EOF
        
        echo "Created sample JSON files"
        ls -la DMAIC_CANONICAL_OUTPUT/
    
    - name: Run DOW Integration Pipeline
      run: |
        python -B DMAIC_V3/dow_integration_executor.py \
          --iteration 1 \
          --target DMAIC_CANONICAL_OUTPUT \
          --verbose
      continue-on-error: true
    
    - name: Check results
      run: |
        if [ -f dow_integration_results_iteration_1.json ]; then
          echo "Results file created successfully"
          cat dow_integration_results_iteration_1.json
        else
          echo "Results file not found"
        fi
    
    - name: Validate DOW structure
      run: |
        python -c "
        import json
        from pathlib import Path
        
        target = Path('DMAIC_CANONICAL_OUTPUT')
        json_files = list(target.glob('*.json'))
        
        print(f'Found {len(json_files)} JSON files')
        
        for file in json_files:
            with open(file) as f:
                data = json.load(f)
            
            checks = {
                'metadata': 'metadata' in data,
                'recursive_hooks': 'recursive_hooks' in data,
                'convergence_metrics': 'convergence_metrics' in data,
                'knowledge_gain': 'knowledge_gain' in data
            }
            
            status = 'PASS' if all(checks.values()) else 'FAIL'
            print(f'{status}: {file.name}')
            for check, passed in checks.items():
                icon = 'OK' if passed else 'MISSING'
                print(f'  [{icon}] {check}')
        "
      continue-on-error: true
    
    - name: Upload results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: dow-integration-results
        path: |
          dow_integration_results_*.json
          ranking.json
          logs/
          DMAIC_CANONICAL_OUTPUT/*.json
        retention-days: 30

  validate:
    name: Validate Results
    needs: integration
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Download results
      uses: actions/download-artifact@v3
      with:
        name: dow-integration-results
    
    - name: Display results summary
      run: |
        echo "=== DOW Integration Results ==="
        if [ -f dow_integration_results_iteration_1.json ]; then
          cat dow_integration_results_iteration_1.json | python -m json.tool
        else
          echo "No results file found"
        fi
        
        echo ""
        echo "=== Enhanced JSON Files ==="
        ls -la DMAIC_CANONICAL_OUTPUT/*.json || echo "No JSON files found"

  deploy:
    name: Deploy to Production
    needs: [test, integration, validate]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy notification
      run: |
        echo "Deploying DOW Integration to production..."
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
    
    - name: Create deployment tag
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        TAG="dow-integration-$(date +%Y%m%d-%H%M%S)"
        git tag -a "$TAG" -m "DOW Integration deployment"
        echo "Created tag: $TAG"
