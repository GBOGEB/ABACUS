name: Validate ABACUS Setup

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

jobs:
  validate-permissions:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Validate GitHub Token Permissions
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "üîç Validating GitHub token permissions for ABACUS..."
        
        # Test basic authentication
        echo "Testing authentication..."
        curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user | jq -r '.login // "Auth failed"'
        
        # Test repository access
        echo "Testing repository access..."
        REPO_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $GITHUB_TOKEN" \
          https://api.github.com/repos/${{ github.repository }})
        
        if [ "$REPO_RESPONSE" = "200" ]; then
          echo "‚úÖ Repository access successful"
        else
          echo "‚ùå Repository access failed (HTTP $REPO_RESPONSE)"
          exit 1
        fi
        
        # Check token scopes
        echo "Checking token scopes..."
        SCOPES=$(curl -s -I -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user | \
          grep -i "x-oauth-scopes:" | cut -d: -f2- | tr -d ' \r\n')
        echo "Available scopes: $SCOPES"
        
        if echo "$SCOPES" | grep -q "repo\|contents:write"; then
          echo "‚úÖ Sufficient permissions detected"
        else
          echo "‚ö†Ô∏è Warning: Limited permissions detected"
        fi
    
    - name: Test Permission Script
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Testing permission validation script..."
        chmod +x test_permissions.sh
        ./test_permissions.sh
    
    - name: Validate Documentation
      run: |
        echo "Checking documentation completeness..."
        
        # Check required files exist
        for file in GITHUB_SETUP.md TROUBLESHOOTING.md README.md .env.example; do
          if [ -f "$file" ]; then
            echo "‚úÖ $file exists"
          else
            echo "‚ùå Missing: $file"
            exit 1
          fi
        done
        
        # Check README has setup instructions
        if grep -q "GitHub Token Setup" README.md; then
          echo "‚úÖ README contains setup instructions"
        else
          echo "‚ùå README missing setup instructions"
          exit 1
        fi
        
        echo "üìö All documentation files validated"

  security-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Check for Secrets in Code
      run: |
        echo "üîí Scanning for accidentally committed secrets..."
        
        # Check for common token patterns (but allow examples)
        if grep -r "ghp_[a-zA-Z0-9]\{36\}" . --exclude-dir=.git | grep -v "example\|sample\|your_token_here"; then
          echo "‚ùå Potential GitHub token found in code!"
          exit 1
        fi
        
        if grep -r "github_pat_[a-zA-Z0-9_]\{82\}" . --exclude-dir=.git | grep -v "example\|sample\|your_token_here"; then
          echo "‚ùå Potential fine-grained GitHub token found!"
          exit 1
        fi
        
        echo "‚úÖ No secrets detected in code"
        
    - name: Validate .gitignore
      run: |
        echo "Checking .gitignore configuration..."
        
        if [ -f .gitignore ]; then
          if grep -q ".env" .gitignore && grep -q "*.tmp" .gitignore; then
            echo "‚úÖ .gitignore properly configured"
          else
            echo "‚ö†Ô∏è .gitignore may be missing important entries"
          fi
        else
          echo "‚ùå .gitignore missing"
          exit 1
        fi