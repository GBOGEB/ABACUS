name: DMAIC V3 Bridge Integration - Test System

on:
  push:
    branches: ["**"]
    paths:
      - 'DMAIC_V3/core/test_system_bridge.py'
      - 'DMAIC_V3/tests/test_bridge_integration.py'
      - 'run_deployment_test_system.py'
      - '.github/workflows/bridge-ci.yml'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - unit
          - integration
      skip_static:
        description: 'Skip static analysis'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.12'
  BRIDGE_VERSION: '1.0.0'

jobs:
  bridge-smoke-tests:
    name: üî• Bridge Smoke Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('DMAIC_V3/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r DMAIC_V3/requirements.txt
          pip install pytest pytest-cov pytest-mock
      
      - name: Run bridge integration tests (smoke)
        run: |
          python -m pytest DMAIC_V3/tests/test_bridge_integration.py -m smoke -v --tb=short
      
      - name: Run deployment smoke tests
        run: |
          python run_deployment_test_system.py --test-suite smoke --skip-static --version ci-smoke-${{ github.sha }}
      
      - name: Upload smoke test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-test-results
          path: |
            DMAIC_V3_OUTPUT/deployment_report.json
            actions.json
            .mcp/monitor.log

  bridge-unit-tests:
    name: üß™ Bridge Unit Tests
    runs-on: ubuntu-latest
    needs: bridge-smoke-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r DMAIC_V3/requirements.txt
          pip install pytest pytest-cov pytest-mock
      
      - name: Run bridge unit tests
        run: |
          python -m pytest DMAIC_V3/tests/test_bridge_integration.py -m unit -v --cov=DMAIC_V3/core/test_system_bridge --cov-report=xml --cov-report=term
      
      - name: Run deployment unit tests
        run: |
          python run_deployment_test_system.py --test-suite unit --skip-static --version ci-unit-${{ github.sha }}
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage.xml
          flags: bridge-unit-tests
          name: bridge-coverage

  bridge-integration-tests:
    name: üîó Bridge Integration Tests
    runs-on: ubuntu-latest
    needs: bridge-unit-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r DMAIC_V3/requirements.txt
          pip install pytest pytest-mock
      
      - name: Run bridge integration tests
        run: |
          python -m pytest DMAIC_V3/tests/test_bridge_integration.py -m integration -v --tb=short
      
      - name: Run deployment integration tests
        run: |
          python run_deployment_test_system.py --test-suite integration --skip-static --version ci-integration-${{ github.sha }}
      
      - name: Upload integration test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            DMAIC_V3_OUTPUT/deployment_report.json
            actions.json
            .mcp/monitor.log

  bridge-static-analysis:
    name: üìä Static Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install analysis tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 mypy pylint black ruff
          pip install -r DMAIC_V3/requirements.txt
      
      - name: Run flake8
        run: |
          flake8 DMAIC_V3/core/test_system_bridge.py run_deployment_test_system.py \
            --max-line-length=120 \
            --extend-ignore=E203,W503 \
            --exclude=__pycache__,.git,build,dist
      
      - name: Run mypy
        run: |
          mypy DMAIC_V3/core/test_system_bridge.py run_deployment_test_system.py \
            --ignore-missing-imports \
            --no-strict-optional \
            --allow-untyped-calls
      
      - name: Run pylint
        continue-on-error: true
        run: |
          pylint DMAIC_V3/core/test_system_bridge.py run_deployment_test_system.py \
            --disable=C0111,R0913,R0914,R0915,C0103 \
            --max-line-length=120
      
      - name: Check formatting with black
        run: |
          black --check --line-length=120 DMAIC_V3/core/test_system_bridge.py run_deployment_test_system.py || true
      
      - name: Run ruff
        run: |
          ruff check DMAIC_V3/core/test_system_bridge.py run_deployment_test_system.py || true

  bridge-full-deployment:
    name: üöÄ Full Deployment Test
    runs-on: ubuntu-latest
    needs: [bridge-smoke-tests, bridge-unit-tests, bridge-integration-tests, bridge-static-analysis]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r DMAIC_V3/requirements.txt
          pip install pytest pytest-mock flake8 mypy pylint
      
      - name: Run full deployment cycle
        run: |
          python run_deployment_test_system.py \
            --test-suite all \
            --version ci-full-${{ github.sha }} \
            --output-dir ./deployment_output
      
      - name: Validate deployment readiness
        run: |
          python -c "
          import json
          from pathlib import Path
          
          report_path = Path('DMAIC_V3_OUTPUT/deployment_report.json')
          if not report_path.exists():
              print('‚ùå Deployment report not found!')
              exit(1)
          
          report = json.loads(report_path.read_text())
          metrics = report['deployment_metrics']
          
          print('=' * 80)
          print('DEPLOYMENT VALIDATION RESULTS')
          print('=' * 80)
          print(f'Version: {metrics[\"version\"]}')
          print(f'Tests Total: {metrics[\"tests_total\"]}')
          print(f'Tests Passed: {metrics[\"tests_passed\"]}')
          print(f'Tests Failed: {metrics[\"tests_failed\"]}')
          print(f'Execution Time: {metrics[\"execution_time_seconds\"]:.2f}s')
          print(f'Runtime Errors: {len(metrics[\"runtime_errors\"])}')
          print(f'Static Analysis: {\"PASSED\" if metrics[\"static_analysis_passed\"] else \"FAILED\"}')
          print(f'Deployment Ready: {\"‚úÖ YES\" if metrics[\"deployment_ready\"] else \"‚ùå NO\"}')
          print('=' * 80)
          
          if not metrics['deployment_ready']:
              print('‚ùå Deployment validation FAILED!')
              exit(1)
          
          print('‚úÖ Deployment validation PASSED!')
          "
      
      - name: Generate deployment summary
        if: always()
        run: |
          echo "## üöÄ Bridge Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ci-full-${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "DMAIC_V3_OUTPUT/deployment_report.json" ]; then
            python -c "
          import json
          from pathlib import Path
          report = json.loads(Path('DMAIC_V3_OUTPUT/deployment_report.json').read_text())
          metrics = report['deployment_metrics']
          print(f'**Tests:** {metrics[\"tests_passed\"]}/{metrics[\"tests_total\"]} passed')
          print(f'**Execution Time:** {metrics[\"execution_time_seconds\"]:.2f}s')
          print(f'**Deployment Ready:** {\"‚úÖ\" if metrics[\"deployment_ready\"] else \"‚ùå\"}')
          " >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: full-deployment-results
          path: |
            DMAIC_V3_OUTPUT/deployment_report.json
            actions.json
            .mcp/monitor.log
            DMAIC_V3/VERSION
            deployment_output/
          retention-days: 30
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'DMAIC_V3_OUTPUT/deployment_report.json';
            
            if (!fs.existsSync(reportPath)) {
              return;
            }
            
            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            const metrics = report.deployment_metrics;
            
            const body = `## üöÄ Bridge Deployment Test Results
            
            **Version:** \`ci-full-${{ github.sha }}\`
            **Status:** ${metrics.deployment_ready ? '‚úÖ READY' : '‚ùå NOT READY'}
            
            ### Test Results
            - **Total Tests:** ${metrics.tests_total}
            - **Passed:** ${metrics.tests_passed} ‚úÖ
            - **Failed:** ${metrics.tests_failed} ${metrics.tests_failed > 0 ? '‚ùå' : ''}
            - **Execution Time:** ${metrics.execution_time_seconds.toFixed(2)}s
            
            ### Analysis
            - **Runtime Errors:** ${metrics.runtime_errors.length}
            - **Static Analysis:** ${metrics.static_analysis_passed ? '‚úÖ PASSED' : '‚ùå FAILED'}
            
            ### Deployment Readiness
            ${metrics.deployment_ready ? '‚úÖ **DEPLOYMENT READY**' : '‚ùå **NOT READY FOR DEPLOYMENT**'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  bridge-deployment-notification:
    name: üì¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: bridge-full-deployment
    if: always()
    
    steps:
      - name: Send notification
        run: |
          echo "üéâ Bridge deployment workflow completed!"
          echo "Check artifacts for detailed results."
