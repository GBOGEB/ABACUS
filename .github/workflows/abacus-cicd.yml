name: ABACUS v032 - CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  ABACUS_VERSION: v032
  PYTHON_VERSION: '3.10'

jobs:
  
  lint-and-validate:
    name: Lint & Validate Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint flake8 black mypy
      
      - name: Run Black formatter check
        run: |
          black --check ABACUS-v032/ || echo "Formatting issues found"
      
      - name: Run Flake8
        run: |
          flake8 ABACUS-v032/ --max-line-length=120 --ignore=E501,W503 || echo "Linting issues found"
      
      - name: Run Pylint
        run: |
          pylint ABACUS-v032/*.py --disable=C0111,C0103 || echo "Pylint issues found"
  
  test-phases:
    name: Test DMAIC Phases
    runs-on: ubuntu-latest
    needs: lint-and-validate
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
      
      - name: Test Phase 0 - Initialization
        run: |
          python -c "from ABACUS-v032.execute_full_dmaic_phases_0_to_8 import FullDMAICOrchestrator; print('Phase 0 OK')"
      
      - name: Test Artifact Ranking System
        run: |
          python ABACUS-v032/artifact_ranking_system.py
  
  execute-dmaic-pipeline:
    name: Execute Full DMAIC Pipeline
    runs-on: ubuntu-latest
    needs: test-phases
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Execute Full Pipeline
        run: |
          python ABACUS-v032/execute_full_dmaic_phases_0_to_8.py
      
      - name: Execute Ranking System
        run: |
          python ABACUS-v032/artifact_ranking_system.py
      
      - name: Upload Execution Reports
        uses: actions/upload-artifact@v3
        with:
          name: dmaic-execution-reports
          path: |
            ABACUS-v032/output/reports/
            ABACUS-v032/output/canonical/
            ABACUS-v032/output/rankings/
  
  update-documentation:
    name: Update Canonical Documentation
    runs-on: ubuntu-latest
    needs: execute-dmaic-pipeline
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Update Version in Documentation
        run: |
          python ABACUS-v032/update_documentation_versions.py
      
      - name: Generate Consolidated Books
        run: |
          python ABACUS-v032/generate_canonical_books.py
      
      - name: Commit Updated Documentation
        run: |
          git config --local user.email "abacus-bot@example.com"
          git config --local user.name "ABACUS Bot"
          git add ABACUS-v032/output/canonical/
          git add ABACUS-v032/output/books/
          git commit -m "docs: Update canonical documentation [skip ci]" || echo "No changes to commit"
  
  deploy-artifacts:
    name: Deploy Artifacts
    runs-on: ubuntu-latest
    needs: update-documentation
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      
      - name: Package Artifacts
        run: |
          mkdir -p deploy/
          cp -r ABACUS-v032/output/ deploy/
          tar -czf abacus-v032-artifacts.tar.gz deploy/
      
      - name: Upload to Release
        uses: actions/upload-artifact@v3
        with:
          name: abacus-v032-release
          path: abacus-v032-artifacts.tar.gz
  
  quality-gate:
    name: Quality Gate Check
    runs-on: ubuntu-latest
    needs: execute-dmaic-pipeline
    steps:
      - uses: actions/checkout@v3
      
      - name: Check Quality Metrics
        run: |
          python ABACUS-v032/check_quality_gate.py
      
      - name: Fail if Quality Below Threshold
        run: |
          if [ -f "ABACUS-v032/output/.quality_failed" ]; then
            echo "Quality gate failed!"
            exit 1
          fi
